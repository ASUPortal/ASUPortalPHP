
(function($){$.fn.inlinemultiselect=function(options){var options=$.extend({separator:", ",separatorSpecial:{},endSeparator:"или",endSeparatorSpecial:{},showAllLink:true,showNoneLink:true,formName:'',showResetLink:true,triggerPopup:{'empty':"[Выбрать...]",'nonempty':"[Сменить...]",'disabled':"[Редактирование недоступно]"},wrapperClass:'selectWrapper',wrapperClassDisabled:'selectWrapperDisabled',controlsClass:'selectControl',listWrapperClass:'listWrapper',checkboxClass:'listBox',checkedClass:'boxChecked',uncheckedClass:'boxUnchecked',disabledClass:'boxDisabled',hoverClass:'boxHover',maxSelected:{},changeCallback:null,showConsoleLog:true},options||{});var logToConsole=function(msg){if(typeof console=="undefined"||!options.showConsoleLog){return;}else{console.log(msg);}};return this.each(function(){if(this.type==='select-multiple'){var msname=$(this).attr('name').replace(/\[\]$/,'');logToConsole("Found multiple select with name: "+msname);var s=options.separatorSpecial[msname]?options.separatorSpecial[msname]:options.separator;var es=options.endSeparatorSpecial[msname]?options.endSeparatorSpecial[msname]:options.endSeparator;logToConsole("separator for "+msname+": "+s);logToConsole("end separator for "+msname+": "+es);var wc=(this.disabled)?options.wrapperClassDisabled:options.wrapperClass;var wrapper=$('<div id="'+msname+'"></div>').addClass(wc);var controls=$('<div/>').appendTo(wrapper)
var optionContainer=$('<div/>').addClass(options.listWrapperClass).appendTo(wrapper);var selectList=$('<ul/>').appendTo(optionContainer);$('<a href="#">закрыть</a>').addClass(options.controlsClass).click(function(){$(this).parents('.selectWrapper').hide();this.blur();if (options.formName!=null && options.formName!='') {document.forms[options.formName].submit();};return false;}).appendTo(controls);if(options.showResetLink){$('<a href="#">сбросить</a>').addClass(options.controlsClass).click(function(){var checkboxgroup=$(this).parents('.'+options.wrapperClass).find(':checkbox');checkboxgroup.each(function(){this.checked=this.defaultChecked;});checkboxgroup.each(function(){$(this).trigger('change');});this.blur();return false;}).appendTo(controls);}
if(options.showAllLink){$('<a href="#">все</a>').addClass(options.controlsClass).click(function(){var checkboxgroup=$(this).parents('.'+options.wrapperClass).find(':checkbox');var groupID=$($(this).parents('.'+options.wrapperClass).get(0)).attr('id');if(options.maxSelected[groupID]&&options.maxSelected[groupID]<checkboxgroup.length){alert("Можно выбрать только "+options.maxSelected[groupID]+" позиций из списка");}else{checkboxgroup.each(function(){if(!this.disabled){this.checked=true;}});checkboxgroup.each(function(){$(this).trigger('change');});}
this.blur();return false;}).appendTo(controls);}
if(options.showNoneLink){$('<a href="#">пусто</a>').addClass(options.controlsClass).click(function(){$(this).parents('.'+options.wrapperClass).find(':checkbox').each(function(){this.checked=false;$(this).trigger('change');});this.blur();return false;}).appendTo(controls);}
var formatOptionStr=function(existing,sep,endSep){var selectedStr='';if(existing.length==1){selectedStr=existing[0]+' ';}else if(existing.length==2){selectedStr=existing.join(' '+endSep+' ')+' ';}else{for(i=0;i<existing.length;i++){if(i==(existing.length-1)){selectedStr+=' '+endSep+' ';}else if(i>0){selectedStr+=sep;}
selectedStr+=existing[i];}
selectedStr+=" ";}
return selectedStr;};var disabledStr='';var existingChoices=[];$('option',this).each(function(){if(this.selected){existingChoices[existingChoices.length]=$(this).text();}});var openLink=null;if(this.disabled){if(options.triggerPopup.disabled!==''){var openLink=$('<span class="selectDisabled">'+options.triggerPopup.disabled+'</span>');}}else{if(existingChoices.length){var openLink=$('<a href="#" id="'+msname+'link">'+options.triggerPopup.nonempty+'</a>');}else{var openLink=$('<a href="#" id="'+msname+'link">'+options.triggerPopup.empty+'</a>');}}
if(openLink&&!this.disabled){openLink.click(function(e){if($(this).hasClass('selectDisabled')){return false;}
$('.'+options.wrapperClass).hide();var wrapperX=(e.pageX>($(window).width()-$('#'+msname).width()))?($(window).width()-($('#'+msname).width()+5)):e.pageX;wrapperX=wrapperX<0?0:wrapperX;var wrapperY=(e.pageY>(($(window).height()+$(document).scrollTop())-$('#'+msname).height()))?(($(window).height()+$(document).scrollTop())-($('#'+msname).height()+5)):e.pageY;wrapperY=wrapperY<0?0:wrapperY;$('#'+msname).css({'top':wrapperY,'left':wrapperX}).show();return false;});}
var openStr=$('<span/>').append($('<strong id="'+msname+'choices">'+disabledStr+formatOptionStr(existingChoices,s,es)+' </strong>')).append(openLink);$('option',this).each(function(idx){var value=$(this).attr('value');var text=$(this).text();logToConsole("Found option ("+text+") in multiple select "+msname+" with value: "+value);var isSelected=$(this).attr('selected')==true?' checked="checked"':'';var label=$('<label/>');var checkbox=$('<input type="checkbox" id="'+msname+idx+'"/>').attr({name:msname+'[]',value:$(this).attr('value'),title:$(this).text()}).addClass(options.checkboxClass);if(this.selected){checkbox.attr({checked:'checked',defaultChecked:true});label.addClass(options.checkedClass);}else{label.addClass(options.uncheckedClass);}
if(this.disabled){checkbox.attr({disabled:'disabled'});label.addClass(options.disabledClass);}
checkbox.bind("click change",function(){var w=$(this).parents('.inlineSelectList').get(0);var defaultCheckbox=false;var existingChoices=[];var disabledStr='';$(this).parents('.'+options.wrapperClass).find(':checkbox').each(function(){if(this.checked){existingChoices[existingChoices.length]=$(this).attr("title");}});if(options.maxSelected[msname]&&existingChoices.length>options.maxSelected[msname]){alert("Sorry, you cannot choose any more.");this.checked=false;return false;}
if(this.checked){$(this).parents('label').removeClass(options.uncheckedClass+" "+options.hoverClass).addClass(options.checkedClass);}else{$(this).parents('label').removeClass(options.checkedClass+" "+options.hoverClass).addClass(options.uncheckedClass);}
var selectedChoicesStr='';if(existingChoices.length){$('#'+msname+'link').html(options.triggerPopup.nonempty);}else{$('#'+msname+'link').html(options.triggerPopup.empty);}
$('#'+msname+'choices').text(formatOptionStr(existingChoices,s,es));if(options.changeCallback){var checkboxes=[];$(this).parents('.'+options.wrapperClass).find(':checkbox').each(function(){checkboxes.push({'id':$(this).attr("id"),'name':$(this).attr("name"),'value':$(this).attr("value"),'title':$(this).attr("title"),'checked':this.checked});});options.changeCallback.call(this,checkboxes);}});label.html($(this).text()).prepend(checkbox).hover(function(){var cbx=$(this).children(':checkbox').get(0);if(cbx&&!cbx.checked&&!cbx.disabled){$(this).addClass(options.hoverClass);}else{$(this).removeClass(options.hoverClass);}},function(){$(this).removeClass(options.hoverClass);});$('<li/>').append(label).appendTo(selectList);logToConsole("Added checkbox and label to selectList for item: "+$(this).text());});$(wrapper).hide();$(this).parents('form').append(wrapper);$(this).before(openStr);logToConsole("Selected items string added to text before select element, and options popup added to form");$(this).remove();logToConsole("Multiple select removed from DOM");}else{logToConsole("Not a multiple select: "+this);}});}})(jQuery);